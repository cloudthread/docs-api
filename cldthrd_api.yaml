openapi: 3.0.3
info:
  version: 0.0.1
  title: Cloudthread API
servers:
  - url: 'https://api.cloudthread.io'
paths:
  /streams/ingest:
    post:
      operationId: ingest_stream_data
      requestBody:
        $ref: '#/components/requestBodies/StreamData'
      security:
        - ApiKeyAuth: []
      responses:
        201:
          description: created
        400:
          description: validation error
        404:
          description: no stream found

  /events:
    post:
      operationId: create_events
      requestBody:
        $ref: '#/components/requestBodies/CreateEvents'
      security:
        - ApiKeyAuth: [ ]
      responses:
        201:
          description: created
        400:
          description: validation error
        404:
          description: no team found

  /tag-catalog:
    get:
      operationId: get_tag_catalog
      parameters:
       - $ref: '#/components/parameters/CatalogKey'
      security:
        - ApiKeyAuth: [ ]
      responses:
        200:
          description: tag data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetTagsPayload'
  
  /cost/metric/{metric_id}:
    get:
      operationId: get_cost_metric_filter_data
      parameters:
       - $ref: '#/components/parameters/MetricID'
       - $ref: '#/components/parameters/StartDate'
       - $ref: '#/components/parameters/EndDate'
       - $ref: '#/components/parameters/CostType'
       - $ref: '#/components/parameters/Amortization'
       - $ref: '#/components/parameters/Exclude'
       - $ref: '#/components/parameters/Granularity'
      security:
        - ApiKeyAuth: [ ]
      responses:
        200:
          description: metric data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetCostViewPayload'

  /unit/metric/{metric_id}:
    get:
      operationId: get_unit_metric_filter_data
      parameters:
       - $ref: '#/components/parameters/MetricID'
       - $ref: '#/components/parameters/StartDate'
       - $ref: '#/components/parameters/EndDate'
       - $ref: '#/components/parameters/CostType'
       - $ref: '#/components/parameters/Amortization'
       - $ref: '#/components/parameters/Exclude'
       - $ref: '#/components/parameters/Granularity'
      security:
        - ApiKeyAuth: [ ]
      responses:
        200:
          description: metric data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetUnitMetricPayload'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

  parameters:
    CatalogKey:
      name: catalog_key
      in: query
      description: Tag Catalog key
      required: true
      schema:
        type: string

    MetricID:
      name: metric_id
      in: path
      description: Cost View or Unit Metric ID
      required: true
      schema:
        type: in

    StartDate:
      name: start_date
      in: query
      description: Start Date
      required: true
      schema:
        type: string

    EndDate:
      name: end_date
      in: query
      description: End Date
      required: true
      schema:
        type: string

    CostType:
      name: cost_type
      in: query
      description: Cost Type or Cost Column ID
      required: false
      schema:
        type: string or integer

    Amortization:
      name: amortization
      in: query
      description: Cost Data Amortization
      required: false
      schema:
        type: boolean

    Exclude:
      name: exclude
      in: query
      description: Excluded Payment Types
      required: false
      schema:
        type: comma-seperated string

    Granularity:
      name: granularity
      in: query
      description: Metric Date Granularity
      required: false
      schema:
        type: string

  requestBodies:
    StreamData:
      description: stream data
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/StreamData'

    CreateEvents:
      description: create events
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/CreateEvents'

  schemas:
    StreamData:
      description: stream data
      properties:
        data_stream_token:
          type: string
          example: sometoken
        metric_agg_func:
          type: string
          example: Sum | Average | Minimum | Maximum
        data:
          type: array
          items:
            $ref: '#/components/schemas/StreamDataPayload'

    StreamDataPayload:
      properties:
        timestamp:
          type: string
          format: date-time
          example: 1234567890
          description: can be either timestamp or datetime string
        metric_name:
          type: string
        metric_value:
          type: number
          format: float
          example: 3.14
        custom_dimensions:
          type: object

    CreateEvents:
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/CreateEventsData'

    CreateEventsData:
      properties:
        timestamp:
          type: string
          format: date-time
          example: 1234567890
          description: can be either timestamp or datetime string
        payload:
          $ref: '#/components/schemas/EventsPayload'
        team_id:
          type: integer
          example: 1

    EventsPayload:
      properties:
        type:
          type: string
        description:
          type: string
        event_url:
          type: string

    GetTagsPayload:
      properties:
        tags:
          type: object
          additionalProperties:
            type: string

    GetCostViewPayload:
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/GetCostViewDataPoint'

    GetCostViewDataPoint:
      properties:
        current_timeframe_cost:
          type: number
          format: float
        previous_timeframe_cost:
          type: number
          format: float
        pop_diff:
          type: number
          format: float
        pop_change:
          type: number
          format: float
        agg_func:
          type: string
        date:
          type: string

    GetUnitMetricPayload:
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/GetUnitMetricDataPoint'

    GetUnitMetricDataPoint:
      properties:
        current_timeframe_denominator:
          type: number
          format: float
        current_timeframe_numerator:
          type: number
          format: float
        current_timeframe_unit_metric:
          type: number
          format: float
        previous_timeframe_denominator:
          type: number
          format: float
        previous_timeframe_numerator:
          type: number
          format: float
        previous_timeframe_unit_metric:
          type: number
          format: float
        pop_diff:
          type: number
          format: float
        pop_change:
          type: number
          format: float
        d_agg_func:
          type: string
        n_agg_func:
          type: string
        date:
          type: string
